<!DOCTYPE html>
<html>
<head>
<title>Deep Sea Hunter - Endless Upgrades</title>
<style>
    body { background-color: #004d7a; overflow:hidden; margin:0; font-family: 'Segoe UI', sans-serif; user-select: none; }
    
    #overlay, #shopOverlay, #victoryOverlay, #levelTransition {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,20,40,0.95); color: white; text-align: center; 
        padding-top: 5%; z-index: 200; display: none;
    }

    /* UI Elements */
    #healthContainer {
        position: fixed; top: 20px; left: 20px; width: 200px; height: 25px; 
        background: #333; border: 2px solid white; z-index: 50;
    }
    #healthBar { width: 100%; height: 100%; background: #4CAF50; transition: width 0.3s; }
    
    #bossUI {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        width: 400px; display: none; text-align: center; z-index: 100;
    }
    #bossHealthContainer { width: 100%; height: 20px; background: #333; border: 2px solid #ff4444; }
    #bossHealthBar { width: 100%; height: 100%; background: #ff4444; transition: width 0.2s; }

    .stats { 
        position: fixed; top: 10px; right: 20px; color: white; text-align: right;
        background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; font-size: 16px; border: 1px solid #008CBA;
    }
    .best { color: #ffd700; font-weight: bold; font-size: 14px; }
    .stat-detail { font-size: 12px; color: #aaa; }

    /* Harpoons and Explosions */
    .harpoon {
        position: absolute; width: 40px; height: 6px; 
        background: linear-gradient(to right, #888, #eee, #333);
        border-radius: 2px; left: -500px; pointer-events: none;
    }
    .harpoon::after { 
        content: ''; position: absolute; right: -5px; top: -3px;
        border-left: 10px solid #555; border-top: 6px solid transparent; border-bottom: 6px solid transparent;
    }
    .explosion {
        position: absolute; width: 100px; height: 100px; border-radius: 50%;
        background: radial-gradient(circle, orange, red, transparent);
        opacity: 0.8; transform: translate(-50%, -50%); pointer-events: none;
        animation: boom 0.3s forwards; z-index: 150;
    }
    @keyframes boom { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

    /* Shop Styling */
    button { padding: 12px 24px; font-size: 16px; cursor: pointer; margin: 10px; background: #008CBA; color: white; border: none; border-radius: 4px; transition: 0.2s; }
    button:hover { background: #00aadd; }
    button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }

    .shop-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 800px; margin: 0 auto; }
    .shop-item { 
        padding: 15px; border: 1px solid #444; background: rgba(255,255,255,0.05); 
        display: flex; flex-direction: column; justify-content: space-between; height: 160px;
    }
    .shop-item h3 { margin: 0 0 5px 0; color: #00ccff; font-size: 18px; }
    .shop-item p { font-size: 13px; color: #ccc; margin: 5px 0; }
    .price-tag { color: #ffd700; font-weight: bold; }
</style>
<script>
   // --- Game State ---
   let myGold = 10;
   let gameActive = true;
   let inShop = false;
   let endlessMode = false;
   let wave = 0;
   let activeEnemies = [];
   
   // --- Player Stats ---
   let playerHealth = 10;
   let playerMaxHealth = 10;
   let playerSpeed = 25;
   let playerDamage = 1;
   let fireRate = 600; // Cooldown in ms
   let lastShotTime = 0;
   
   // --- Upgrades ---
   let tripleShot = false;
   let explosiveShot = false;
   let maxHealthLvl = 1;
   
   // --- Enemy State ---
   let bossHP = 15;
   let bossMaxHP = 15;
   let enemyBaseSpeed = 0.9; 

   function fixImg(el, name, color) {
       el.onerror = null;
       el.src = `https://placehold.co/100x60/${color}/white?text=${name}`;
   }

   function updateUI() {
       // Health Bars
       document.getElementById('healthBar').style.width = Math.max(0, (playerHealth / playerMaxHealth) * 100) + "%";
       
       let bUI = document.getElementById('bossUI');
       let boss = document.getElementById('bossShark');
       if (boss.style.display !== 'none') {
           bUI.style.display = 'block';
           document.getElementById('bossHealthBar').style.width = Math.max(0, (bossHP / bossMaxHP) * 100) + "%";
       } else { bUI.style.display = 'none'; }

       // Text Displays
       document.getElementById('waveDisplay').innerText = endlessMode ? "Wave: " + wave : "Level 1: The Hunt";
       document.getElementById('scoreDisplay').innerText = "Gold: " + myGold;
       
       // Detailed Stats
       let statsText = `Dmg: ${playerDamage} | Reload: ${(fireRate/1000).toFixed(1)}s`;
       if(explosiveShot) statsText += " | EXPLOSIVE";
       document.getElementById('statDetails').innerText = statsText;

       let bWave = localStorage.getItem('sharkBestWave') || 0;
       document.getElementById('highScoreDisplay').innerHTML = `<span class="best">BEST WAVE: ${bWave}</span>`;
   }

   function initGame() {
       // Start Story Mode
       document.getElementById('bossShark').style.display = 'block';
       for (let i = 0; i < 3; i++) spawnShark('minion' + i);
       updateUI();
   }

   function startEndlessMode() {
       endlessMode = true;
       wave = 0;
       document.getElementById('levelTransition').style.display = 'none';
       gameActive = true;
       startWave();
   }

   function startWave() {
       wave++;
       enemyBaseSpeed += 0.15;
       clearEnemies();
       
       // Spawn Minions
       let count = 3 + Math.floor(wave * 1.5);
       for (let i = 0; i < count; i++) spawnShark('shark' + i);
       
       // Boss every 5 waves
       if (wave % 5 === 0) {
           let b = document.getElementById('bossShark');
           b.style.display = 'block'; b.style.left = "1200px";
           bossMaxHP = 20 + (wave * 5); // Boss scales HP
           bossHP = bossMaxHP;
       }
       updateUI();
   }

   function clearEnemies() {
       activeEnemies.forEach(id => { let e = document.getElementById(id); if (e) e.remove(); });
       activeEnemies = [];
   }

   function spawnShark(id) {
       let img = document.createElement('img');
       img.id = id; img.src = "ignore/BaskingShark.jpg";
       img.onerror = function() { fixImg(this, 'Shark', '224466'); };
       img.style.position = "absolute"; img.style.width = "80px"; img.style.height = "40px";
       img.style.left = (window.innerWidth + Math.random() * 800) + "px";
       img.style.top = Math.random() * (window.innerHeight - 100) + "px";
       document.body.appendChild(img);
       activeEnemies.push(id);
   }

   // --- Shooting Logic ---

   function myShoot(event) {
       if (!gameActive || inShop) return;
       
       // Cooldown Check
       let now = Date.now();
       if (now - lastShotTime < fireRate) return;
       lastShotTime = now;

       let p = document.getElementById('myImg01').getBoundingClientRect();
       let sX = p.left + 30, sY = p.top + 30;
       let dX = event.clientX - sX, dY = event.clientY - sY;
       let angle = Math.atan2(dY, dX);
       let dist = Math.sqrt(dX*dX + dY*dY);
       let vX = (dX/dist)*22, vY = (dY/dist)*22;

       fireHarpoon('hp1', sX, sY, vX, vY, angle);
       if (tripleShot) {
           fireHarpoon('hpB', sX, sY, vX, vY - 3, angle - 0.15);
           fireHarpoon('hpC', sX, sY, vX, vY + 3, angle + 0.15);
       }
   }

   function fireHarpoon(id, sX, sY, vX, vY, angle) {
       let h = document.getElementById(id);
       h.style.left = sX + 'px'; h.style.top = sY + 'px';
       h.style.transform = `rotate(${angle}rad)`;
       
       // If explosive, change color
       h.style.background = explosiveShot ? "linear-gradient(to right, red, orange)" : "linear-gradient(to right, #888, #eee, #333)";

       let lifespan = 0;
       let timer = setInterval(() => {
           lifespan++;
           if (!gameActive || lifespan > 100) { clearInterval(timer); h.style.left = "-500px"; return; }
           
           h.style.left = parseFloat(h.style.left) + vX + 'px';
           h.style.top = parseFloat(h.style.top) + vY + 'px';
           
           // Check Minion Hits
           for (let i = 0; i < activeEnemies.length; i++) {
               let eId = activeEnemies[i];
               if (myHitOther(id, eId)) {
                   h.style.left = "-500px"; clearInterval(timer);
                   if (explosiveShot) createExplosion(parseFloat(h.style.left), parseFloat(h.style.top));
                   killEnemy(eId, i);
                   return; 
               }
           }
           
           // Check Boss Hit
           let boss = document.getElementById('bossShark');
           if (boss.style.display !== 'none' && myHitOther(id, 'bossShark')) {
               h.style.left = "-500px"; clearInterval(timer); 
               
               if (explosiveShot) {
                   createExplosion(parseFloat(h.style.left), parseFloat(h.style.top));
                   bossHP -= (playerDamage + 2); // Explosion bonus
               } else {
                   bossHP -= playerDamage;
               }

               updateUI();
               if (bossHP <= 0) { 
                   boss.style.display = 'none'; 
                   if (!endlessMode) { 
                       gameActive = false; 
                       clearEnemies();
                       document.getElementById('levelTransition').style.display = 'block'; 
                   } else { myGold += 100; updateUI(); }
               }
           }
       }, 20);
   }

   function createExplosion(x, y) {
        let div = document.createElement('div');
        div.className = 'explosion';
        div.style.left = x + 'px'; div.style.top = y + 'px';
        document.body.appendChild(div);
        
        // Splash Damage Area Check
        activeEnemies.forEach((eId, idx) => {
            let el = document.getElementById(eId);
            if(!el) return;
            let rect = el.getBoundingClientRect();
            let dist = Math.hypot(rect.x - x, rect.y - y);
            if(dist < 100) { // Blast radius
                killEnemy(eId, idx);
            }
        });
        
        setTimeout(() => div.remove(), 350);
   }

   function myHitOther(my1, my2) {
       const b1 = document.getElementById(my1).getBoundingClientRect();
       const e = document.getElementById(my2);
       if(!e) return false;
       const b2 = e.getBoundingClientRect();
       return !(b1.right < b2.left || b1.left > b2.right || b1.bottom < b2.top || b1.top > b2.bottom);
   }

   function killEnemy(id, index) {
       let e = document.getElementById(id); 
       if (e) {
           e.remove();
           // Determine if id is still in array (splash damage might try to kill twice)
           let idx = activeEnemies.indexOf(id);
           if(idx > -1) {
               activeEnemies.splice(idx, 1);
               myGold += 5; updateUI();
           }
       }
       if (endlessMode && activeEnemies.length === 0) { 
           if (wave % 2 === 0) openShop(); else startWave(); 
       }
   }

   // --- Shop Logic ---

   function openShop() { 
       inShop = true; 
       document.getElementById('shopOverlay').style.display = 'block'; 
       updateShopUI();
   }

   function closeShop() { 
       inShop = false; 
       document.getElementById('shopOverlay').style.display = 'none'; 
       startWave(); 
   }

   function getCost(type) {
       if (type === 'heal') return 10;
       if (type === 'damage') return 25 * playerDamage;
       if (type === 'speed') return 15 + ((playerSpeed-25) * 2);
       if (type === 'reload') return Math.floor(30 * (600/fireRate));
       if (type === 'maxhp') return 30 * maxHealthLvl;
       if (type === 'triple') return 200;
       if (type === 'explosive') return 500;
       return 0;
   }
   
   function updateShopUI() {
       document.getElementById('shopGold').innerText = myGold;
       
       // Update button texts with current prices
       document.getElementById('btnHeal').innerHTML = `Buy (${getCost('heal')}g)`;
       document.getElementById('btnDmg').innerHTML = `Buy (${getCost('damage')}g)`;
       document.getElementById('btnSpeed').innerHTML = `Buy (${getCost('speed')}g)`;
       document.getElementById('btnReload').innerHTML = `Buy (${getCost('reload')}g)`;
       document.getElementById('btnMaxHP').innerHTML = `Buy (${getCost('maxhp')}g)`;
       
       let btnTrip = document.getElementById('btnTriple');
       if(tripleShot) { btnTrip.innerText = "OWNED"; btnTrip.disabled = true; } 
       else btnTrip.innerHTML = `Buy (${getCost('triple')}g)`;

       let btnExp = document.getElementById('btnExplosive');
       if(explosiveShot) { btnExp.innerText = "OWNED"; btnExp.disabled = true; }
       else btnExp.innerHTML = `Buy (${getCost('explosive')}g)`;
   }

   function buy(item) {
       let cost = getCost(item);
       if (myGold < cost) return; // Not enough money

       if (item === 'heal') {
           if (playerHealth >= playerMaxHealth) return;
           myGold -= cost; playerHealth = playerMaxHealth;
       }
       else if (item === 'damage') {
           myGold -= cost; playerDamage++;
       }
       else if (item === 'speed') {
           myGold -= cost; playerSpeed += 5;
       }
       else if (item === 'reload') {
           if (fireRate <= 100) return; // Cap max speed
           myGold -= cost; fireRate -= 50;
       }
       else if (item === 'maxhp') {
           myGold -= cost; maxHealthLvl++;
           playerMaxHealth += 5; playerHealth += 5;
       }
       else if (item === 'triple') {
           if (tripleShot) return;
           myGold -= cost; tripleShot = true;
       }
       else if (item === 'explosive') {
           if (explosiveShot) return;
           myGold -= cost; explosiveShot = true;
       }

       updateUI();
       updateShopUI();
   }

   // --- Game Loop ---

   setInterval(() => {
       if (!gameActive || inShop) return;
       let p = document.getElementById('myImg01');
       let px = parseFloat(p.style.left), py = parseFloat(p.style.top);
       
       // Gravity
       if (py < window.innerHeight - 80) p.style.top = (py + 1.5) + 'px';

       // Boss Movement
       let boss = document.getElementById('bossShark');
       if (boss.style.display !== 'none') {
           let bx = parseFloat(boss.style.left), by = parseFloat(boss.style.top);
           boss.style.left = (bx < px ? bx + (enemyBaseSpeed * 0.7) : bx - (enemyBaseSpeed * 0.7)) + 'px';
           boss.style.top = (by < py ? by + (enemyBaseSpeed * 0.7) : by - (enemyBaseSpeed * 0.7)) + 'px';
           if (myHitOther('myImg01', 'bossShark')) { playerHealth -= 0.05; updateUI(); }
       }

       // Minion Movement
       activeEnemies.forEach(id => {
           let e = document.getElementById(id); if(!e) return;
           let ex = parseFloat(e.style.left), ey = parseFloat(e.style.top);
           e.style.left = (ex < px ? ex + enemyBaseSpeed : ex - enemyBaseSpeed) + 'px';
           e.style.top = (ey < py ? ey + enemyBaseSpeed : ey - enemyBaseSpeed) + 'px';
           if (myHitOther('myImg01', id)) { playerHealth -= 1; e.style.left = (ex + 250) + 'px'; updateUI(); }
       });

       // Death Check
       if (playerHealth <= 0) { 
           gameActive = false; 
           if (endlessMode) {
                let best = localStorage.getItem('sharkBestWave') || 0;
                if (wave > best) localStorage.setItem('sharkBestWave', wave);
           }
           document.getElementById('overlay').style.display='block'; 
       }
   }, 40);

   window.onload = initGame;
</script>
</head>

<body onclick="myShoot(event)" onkeydown="
    if(!gameActive || inShop) return;
    let p = document.getElementById('myImg01');
    let x = parseFloat(p.style.left), y = parseFloat(p.style.top);
    if (event.key == 'd' && x < window.innerWidth - 60) p.style.left = (x + playerSpeed) + 'px';
    if (event.key == 'a' && x > 0) p.style.left = (x - playerSpeed) + 'px';
    if (event.key == 'w' && y > 0) p.style.top = (y - 60) + 'px';
    if (event.key == 's' && y < window.innerHeight - 60) p.style.top = (y + playerSpeed) + 'px';
">

<div id="healthContainer"><div id="healthBar"></div></div>
<div id="bossUI"><label>BOSS</label><div id="bossHealthContainer"><div id="bossHealthBar"></div></div></div>

<div class="stats">
    <span id="waveDisplay">Level 1</span><br>
    <span id="scoreDisplay">Gold: 10</span><br>
    <div id="statDetails" class="stat-detail"></div>
    <div id="highScoreDisplay"></div>
</div>

<div id="levelTransition">
    <h1 style="color: #ffd700;">LEVEL 1 COMPLETE!</h1>
    <p>The alpha has fallen. Now, face the never-ending swarm...</p>
    <button onclick="startEndlessMode()">ENTER ENDLESS MODE</button>
</div>

<div id="shopOverlay">
    <h1>ARMORY</h1>
    <p>Gold: <span id="shopGold" style="color:#ffd700; font-size:24px;">0</span></p>
    
    <div class="shop-grid">
        <div class="shop-item">
            <h3>Repair Hull</h3>
            <p>Restore 100% HP</p>
            <button id="btnHeal" onclick="buy('heal')">Buy</button>
        </div>
        <div class="shop-item">
            <h3>Sharpen Spear</h3>
            <p>+1 Damage (Scales)</p>
            <button id="btnDmg" onclick="buy('damage')">Buy</button>
        </div>
        <div class="shop-item">
            <h3>Quick Reload</h3>
            <p>Faster Firing Speed</p>
            <button id="btnReload" onclick="buy('reload')">Buy</button>
        </div>
        <div class="shop-item">
            <h3>Iron Plating</h3>
            <p>+5 Max Health</p>
            <button id="btnMaxHP" onclick="buy('maxhp')">Buy</button>
        </div>
        <div class="shop-item">
            <h3>Engine Boost</h3>
            <p>Swim Speed</p>
            <button id="btnSpeed" onclick="buy('speed')">Buy</button>
        </div>
        <div class="shop-item">
            <h3>Triple Shot</h3>
            <p>Fire 3 Harpoons</p>
            <button id="btnTriple" onclick="buy('triple')">Buy</button>
        </div>
    </div>
    
    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
        <div class="shop-item" style="width: 300px; margin: 0 auto; border-color: red;">
            <h3 style="color: red;">EXPLOSIVE TIPS</h3>
            <p>Harpoons explode on impact. Deals Splash DMG.</p>
            <button id="btnExplosive" onclick="buy('explosive')">Buy (500g)</button>
        </div>
    </div>

    <br><button onclick="closeShop()" style="background: #4CAF50; width: 200px;">NEXT WAVE >></button>
</div>

<div id="overlay"><h1>GAME OVER</h1><button onclick="location.reload()">RESTART</button></div>

<img id="myImg01" src="ignore/meowl.png" onerror="fixImg(this, 'Player', 'orange')" style="position:absolute; width:60px; height:60px; left:50px; top:200px; z-index:100;">
<img id="bossShark" src="ignore/BaskingShark.jpg" onerror="fixImg(this, 'BOSS', 'red')" style="position:absolute; width:220px; height:120px; left:1200px; top:200px; border:4px solid red; display:none; z-index:90;">

<div id="hp1" class="harpoon"></div>
<div id="hpB" class="harpoon"></div>
<div id="hpC" class="harpoon"></div>

</body>
</html>
