<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pedro-Style NYC Alley (Advanced)</title>
<style>
html,body{margin:0;background:#0a0a0a;overflow:hidden}
canvas{display:block;margin:auto;background:#111}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
/* =========================================================
   CORE
========================================================= */
const c=document.getElementById("c"),ctx=c.getContext("2d");
c.width=1280;c.height=640;

/* =========================================================
   INPUT
========================================================= */
const keys={},mouse={x:0,y:0,l:false};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
c.onmousemove=e=>{
  const r=c.getBoundingClientRect();
  mouse.x=e.clientX-r.left;
  mouse.y=e.clientY-r.top;
};
c.onmousedown=()=>mouse.l=true;
c.onmouseup=()=>mouse.l=false;

/* =========================================================
   MAP â€“ NYC ALLEY
========================================================= */
const platforms=[
  {x:-400,y:600,w:2400,h:80},
  {x:80,y:500,w:260,h:20},
  {x:420,y:460,w:260,h:20},
  {x:760,y:420,w:260,h:20},
  {x:1050,y:380,w:200,h:20},
  {x:250,y:330,w:180,h:20},
  {x:620,y:280,w:180,h:20},
];

const props=[
  {x:120,y:460,w:70,h:40,type:"dumpster"},
  {x:460,y:430,w:40,h:30,type:"ac"},
  {x:820,y:390,w:40,h:30,type:"ac"},
];

/* =========================================================
   DECALS & PARTICLES (STYLIZED GORE)
========================================================= */
const decals=[],particles=[],chunks=[];
function spawnDecal(x,y){
  decals.push({x,y,r:12+Math.random()*12,l:500});
}
class Particle{
  constructor(x,y){
    this.x=x;this.y=y;
    this.vx=(Math.random()-.5)*6;
    this.vy=(Math.random()-.7)*6;
    this.l=40;
  }
  update(){this.vy+=0.4;this.x+=this.vx;this.y+=this.vy;this.l--;}
  draw(){
    ctx.fillStyle="rgba(120,0,0,.7)";
    ctx.fillRect(this.x,this.y,3,3);
  }
}
class Chunk{
  constructor(x,y){
    this.x=x;this.y=y;
    this.vx=(Math.random()-.5)*8;
    this.vy=-6-Math.random()*4;
    this.r=Math.random()*6;
  }
  update(){
    this.vy+=0.6;
    this.x+=this.vx;this.y+=this.vy;
    platforms.forEach(p=>{
      if(this.x>p.x&&this.x<p.x+p.w&&this.y>p.y&&this.y<p.y+20){
        this.y=p.y;this.vy*=-0.2;
      }
    });
  }
  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.rotate(this.r);
    ctx.fillStyle="#400";
    ctx.fillRect(-4,-4,8,8);
    ctx.restore();
  }
}

/* =========================================================
   WEAPONS
========================================================= */
const weapons=[
  {name:"pistol",rate:7,spread:0.02,pellets:1,speed:18},
  {name:"shotgun",rate:22,spread:0.4,pellets:7,speed:16}
];
let weaponIndex=0;
c.onwheel=e=>{
  weaponIndex=(weaponIndex+(e.deltaY>0?1:-1)+weapons.length)%weapons.length;
};

/* =========================================================
   BULLETS
========================================================= */
const bullets=[];
class Bullet{
  constructor(x,y,a,s){
    this.x=x;this.y=y;
    this.vx=Math.cos(a)*s;
    this.vy=Math.sin(a)*s;
    this.life=50;
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
  draw(){
    ctx.fillStyle="#0ff";
    ctx.fillRect(this.x-2,this.y-2,4,4);
  }
}

/* =========================================================
   HUMANOID RIG
========================================================= */
function drawHuman(x,y,aim,dead=false){
  ctx.save();
  ctx.translate(x,y);
  // legs
  ctx.fillStyle="#222";
  ctx.fillRect(-5,26,4,18);
  ctx.fillRect(1,26,4,18);
  // torso
  ctx.fillStyle=dead?"#333":"#444";
  ctx.fillRect(-8,6,16,24);
  // head
  ctx.beginPath();
  ctx.arc(0,-4,7,0,Math.PI*2);
  ctx.fillStyle="#555";
  ctx.fill();
  // arm + gun
  ctx.rotate(aim);
  ctx.fillStyle="#333";
  ctx.fillRect(4,10,14,3);
  ctx.fillStyle="#111";
  ctx.fillRect(18,9,10,5);
  ctx.restore();
}

/* =========================================================
   PLAYER
========================================================= */
const player={x:100,y:300,vx:0,vy:0,w:20,h:48,ground:false,cd:0};
function updatePlayer(){
  player.vx=((keys.a?-1:0)+(keys.d?1:0))*6;
  player.vy+=0.8;
  if(keys[" "]&&player.ground){player.vy=-14;player.ground=false;}
  player.x+=player.vx;player.y+=player.vy;
  player.ground=false;
  platforms.forEach(p=>{
    if(player.x+player.w>p.x&&player.x<p.x+p.w){
      if(player.y+player.h<=p.y+10&&player.y+player.h>=p.y){
        player.y=p.y-player.h;player.vy=0;player.ground=true;
      }
    }
  });
  player.cd--;
  if(mouse.l&&player.cd<=0){
    const w=weapons[weaponIndex];
    const cx=player.x+player.w/2,cy=player.y+14;
    const ang=Math.atan2(mouse.y-cy,mouse.x-cx);
    for(let i=0;i<w.pellets;i++)
      bullets.push(new Bullet(cx,cy,ang+(Math.random()-.5)*w.spread,w.speed));
    player.cd=w.rate;
  }
}

/* =========================================================
   ENEMY
========================================================= */
class Enemy{
  constructor(x,y){
    this.x=x;this.y=y;this.vx=1.2;this.vy=0;
    this.state="patrol";this.dir=1;this.dead=false;
    this.patrol=[x-100,x+100];
  }
  hit(x,y){
    spawnDecal(x,y);
    for(let i=0;i<8;i++)particles.push(new Particle(x,y));
    for(let i=0;i<2;i++)chunks.push(new Chunk(x,y));
    this.dead=true;
  }
  update(){
    if(!this.dead){
      if(this.state==="patrol"){
        this.x+=this.vx*this.dir;
        if(this.x<this.patrol[0]||this.x>this.patrol[1])this.dir*=-1;
        if(Math.abs(player.x-this.x)<260)this.state="attack";
      }
    }
    this.vy+=0.6;this.y+=this.vy;
    platforms.forEach(p=>{
      if(this.x>p.x&&this.x<p.x+p.w){
        if(this.y+48<=p.y+10&&this.y+48>=p.y){
          this.y=p.y-48;this.vy=0;
        }
      }
    });
  }
  draw(){
    drawHuman(this.x,this.y,Math.atan2(player.y-this.y,player.x-this.x),this.dead);
  }
}
const enemies=[new Enemy(520,440),new Enemy(820,400),new Enemy(1100,360)];

/* =========================================================
   LOOP
========================================================= */
function loop(){
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#1a1a1a";
  platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));
  decals.forEach(d=>{
    ctx.fillStyle=`rgba(80,0,0,${d.l/500})`;
    ctx.beginPath();ctx.arc(d.x,d.y,d.r,0,Math.PI*2);ctx.fill();
    d.l--;
  });

  updatePlayer();
  enemies.forEach(e=>e.update());

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];b.update();
    enemies.forEach(e=>{
      if(!e.dead&&b.x>e.x-8&&b.x<e.x+8&&b.y>e.y&&b.y<e.y+48){
        e.hit(b.x,b.y);b.life=0;
      }
    });
    if(b.life<=0)bullets.splice(i,1);
  }

  bullets.forEach(b=>b.draw());
  particles.forEach(p=>{p.update();p.draw();});
  chunks.forEach(c=>{c.update();c.draw();});
  enemies.forEach(e=>e.draw());
  drawHuman(player.x,player.y,
    Math.atan2(mouse.y-(player.y+14),mouse.x-(player.x+10)));

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
