<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pedro-Style NYC Alley Demo</title>
<style>
html,body{margin:0;background:#0b0b0b;overflow:hidden}
canvas{display:block;margin:auto;background:#111}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
/* =========================================================
   CORE
========================================================= */
const canvas=c=document.getElementById("c");
const ctx=c.getContext("2d");
c.width=1280; c.height=640;

/* =========================================================
   INPUT
========================================================= */
const keys={},mouse={x:0,y:0,l:false};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
c.onmousemove=e=>{
  const r=c.getBoundingClientRect();
  mouse.x=e.clientX-r.left;
  mouse.y=e.clientY-r.top;
};
c.onmousedown=()=>mouse.l=true;
c.onmouseup=()=>mouse.l=false;
c.onwheel=e=>{
  player.weapon=(player.weapon+ (e.deltaY>0?1:-1)+weapons.length)%weapons.length;
};

/* =========================================================
   MAP â€“ NYC ALLEY
========================================================= */
const platforms=[
  {x:-300,y:600,w:2000,h:60},
  {x:0,y:520,w:300,h:20},
  {x:350,y:480,w:260,h:20},
  {x:700,y:440,w:260,h:20},
  {x:1050,y:400,w:220,h:20},
  {x:200,y:360,w:180,h:20},
  {x:600,y:300,w:180,h:20},
];

const props=[
  {x:80,y:480,w:60,h:40,type:"dumpster"},
  {x:430,y:450,w:40,h:30,type:"ac"},
  {x:760,y:410,w:40,h:30,type:"ac"},
];

/* =========================================================
   WEAPONS
========================================================= */
const weapons=[
  {name:"pistol",rate:8,spread:0.03,pellets:1,speed:18},
  {name:"shotgun",rate:22,spread:0.35,pellets:7,speed:16}
];

/* =========================================================
   BULLETS
========================================================= */
const bullets=[];
class Bullet{
  constructor(x,y,a,s){
    this.x=x;this.y=y;
    this.vx=Math.cos(a)*s;
    this.vy=Math.sin(a)*s;
    this.life=50;
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
  draw(){
    ctx.fillStyle="#0ff";
    ctx.fillRect(this.x-2,this.y-2,4,4);
  }
}

/* =========================================================
   HUMANOID DRAW
========================================================= */
function drawHuman(x,y,flip,aim,dead=false){
  ctx.save();
  ctx.translate(x,y);
  if(flip) ctx.scale(-1,1);

  // legs
  ctx.fillStyle="#222";
  ctx.fillRect(-6,28,4,18);
  ctx.fillRect(2,28,4,18);

  // torso
  ctx.fillStyle=dead?"#333":"#444";
  ctx.fillRect(-8,8,16,24);

  // head
  ctx.beginPath();
  ctx.arc(0,0,7,0,Math.PI*2);
  ctx.fillStyle="#555";
  ctx.fill();

  // arm + gun
  ctx.rotate(aim);
  ctx.fillStyle="#333";
  ctx.fillRect(4,10,14,3); // arm
  ctx.fillStyle="#111";
  ctx.fillRect(14,9,10,5); // gun slide
  ctx.fillRect(22,10,4,3); // barrel

  ctx.restore();
}

/* =========================================================
   PLAYER
========================================================= */
const player={
  x:100,y:300,vx:0,vy:0,w:20,h:48,ground:false,
  weapon:0,cd:0
};
function updatePlayer(){
  player.vx=((keys.a?-1:0)+(keys.d?1:0))*6;
  player.vy+=0.8;
  if(keys[" "]&&player.ground){player.vy=-14;player.ground=false;}
  player.x+=player.vx; player.y+=player.vy;

  player.ground=false;
  platforms.forEach(p=>{
    if(player.x+player.w>p.x&&player.x<p.x+p.w){
      if(player.y+player.h<=p.y+10&&player.y+player.h+player.vy>=p.y){
        player.y=p.y-player.h;player.vy=0;player.ground=true;
      }
    }
  });

  player.cd--;
  if(mouse.l&&player.cd<=0){
    const w=weapons[player.weapon];
    const cx=player.x+player.w/2,cy=player.y+14;
    const ang=Math.atan2(mouse.y-cy,mouse.x-cx);
    for(let i=0;i<w.pellets;i++)
      bullets.push(new Bullet(
        cx,cy,ang+(Math.random()-.5)*w.spread,w.speed
      ));
    player.cd=w.rate;
  }
}

/* =========================================================
   ENEMY AI
========================================================= */
class Enemy{
  constructor(x,y){
    this.x=x;this.y=y;
    this.vx=1.2;this.vy=0;
    this.state="patrol";
    this.dir=1;
    this.dead=false;
    this.cool=0;
    this.patrol=[x-80,x+80];
  }
  update(){
    if(this.dead){
      this.vy+=0.7; this.y+=this.vy;
    } else {
      const dx=player.x-this.x;
      if(Math.abs(dx)<240) this.state="attack";
      else this.state="patrol";

      if(this.state==="patrol"){
        this.x+=this.vx*this.dir;
        if(this.x<this.patrol[0]||this.x>this.patrol[1]) this.dir*=-1;
      }

      if(this.state==="attack"){
        this.dir=dx>0?1:-1;
        this.cool--;
        if(this.cool<=0){
          bullets.push(new Bullet(
            this.x,this.y+10,
            Math.atan2(player.y-this.y,dx),14
          ));
          this.cool=40;
        }
      }
    }

    this.vy+=0.6; this.y+=this.vy;
    platforms.forEach(p=>{
      if(this.x>p.x&&this.x<p.x+p.w){
        if(this.y+48<=p.y+10&&this.y+48>=p.y){
          this.y=p.y-48; this.vy=0;
        }
      }
    });
  }
  draw(){
    drawHuman(this.x,this.y,this.dir<0,
      Math.atan2(player.y-this.y,player.x-this.x),this.dead);
  }
}

const enemies=[
  new Enemy(500,420),
  new Enemy(820,380),
  new Enemy(1100,350)
];

/* =========================================================
   LOOP
========================================================= */
function loop(){
  ctx.clearRect(0,0,c.width,c.height);

  // background
  ctx.fillStyle="#1a1a1a";
  platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));
  props.forEach(o=>{
    ctx.fillStyle=o.type==="dumpster"?"#2b3":"#333";
    ctx.fillRect(o.x,o.y,o.w,o.h);
  });

  updatePlayer();
  enemies.forEach(e=>e.update());

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.update();
    enemies.forEach(e=>{
      if(!e.dead && b.x>e.x-8&&b.x<e.x+8&&b.y>e.y&&b.y<e.y+48){
        e.dead=true; b.life=0;
      }
    });
    if(b.life<=0) bullets.splice(i,1);
  }

  bullets.forEach(b=>b.draw());
  enemies.forEach(e=>e.draw());
  drawHuman(player.x,player.y,false,
    Math.atan2(mouse.y-(player.y+14),mouse.x-(player.x+10)));

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
