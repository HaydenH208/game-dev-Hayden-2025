<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pedro-Style Industrial Demo</title>
<style>
html,body{margin:0;background:#0e0e0e;overflow:hidden}
canvas{display:block;margin:auto;background:#151515}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
// ==========================================================
// CANVAS
// ==========================================================
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
canvas.width=1200;
canvas.height=600;

// ==========================================================
// INPUT
// ==========================================================
const keys={};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

const mouse={x:0,y:0,l:false,r:false};
canvas.onmousemove=e=>{
  const b=canvas.getBoundingClientRect();
  mouse.x=e.clientX-b.left;
  mouse.y=e.clientY-b.top;
};
canvas.onmousedown=e=>{
  if(e.button===0) mouse.l=true;
  if(e.button===2) mouse.r=true;
};
canvas.onmouseup=e=>{
  if(e.button===0) mouse.l=false;
  if(e.button===2) mouse.r=false;
};
canvas.oncontextmenu=e=>e.preventDefault();

// ==========================================================
// UTILS
// ==========================================================
function rr(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

// ==========================================================
// INDUSTRIAL ALLEY MAP
// ==========================================================
const platforms=[
  {x:-200,y:560,w:2000,h:60}, // ground
  {x:200,y:450,w:200,h:20},
  {x:480,y:380,w:220,h:20},
  {x:780,y:320,w:240,h:20},
  {x:350,y:260,w:180,h:20},
  {x:900,y:460,w:180,h:20},
  {x:50,y:350,w:140,h:20},
];

// ==========================================================
// DECALS & PARTICLES
// ==========================================================
const decals=[],particles=[];
function decal(x,y){
  decals.push({x,y,r:12+Math.random()*10,l:350});
}
class Particle{
  constructor(x,y){
    this.x=x;this.y=y;
    this.vx=(Math.random()-.5)*6;
    this.vy=(Math.random()-.7)*6;
    this.l=35;
  }
  update(){
    this.vy+=0.4;
    this.x+=this.vx;
    this.y+=this.vy;
    this.l--;
  }
  draw(){
    ctx.fillStyle="rgba(120,0,0,.8)";
    ctx.fillRect(this.x,this.y,3,3);
  }
}

// ==========================================================
// BULLETS
// ==========================================================
const bullets=[];
class Bullet{
  constructor(x,y,a,power,enemy=false){
    this.x=x;this.y=y;
    this.vx=Math.cos(a)*18;
    this.vy=Math.sin(a)*18;
    this.enemy=enemy;
    this.life=50;
    this.power=power;
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
  draw(){
    ctx.fillStyle=this.enemy?"#ff5555":"#00ffff";
    ctx.fillRect(this.x-2,this.y-2,4,4);
  }
}

// ==========================================================
// PLAYER
// ==========================================================
class Player{
  constructor(){
    this.x=80;this.y=300;
    this.w=30;this.h=60;
    this.vx=0;this.vy=0;
    this.g=false;
    this.cd=0;
  }
  update(){
    this.vx=((keys.a?-1:0)+(keys.d?1:0))*6;
    this.vy+=0.8;
    if(keys[" "]&&this.g){this.vy=-14;this.g=false;}
    this.x+=this.vx;this.y+=this.vy;

    this.g=false;
    platforms.forEach(p=>{
      if(this.x+this.w>p.x && this.x<p.x+p.w){
        if(this.y+this.h<=p.y+10 && this.y+this.h+this.vy>=p.y){
          this.y=p.y-this.h;
          this.vy=0;
          this.g=true;
        }
      }
    });

    const cx=this.x+this.w/2;
    const cy=this.y+this.h*0.35;
    const ang=Math.atan2(mouse.y-cy,mouse.x-cx);

    this.cd--;
    if(mouse.l && this.cd<=0){
      bullets.push(new Bullet(cx,cy,ang,1,false));
      this.cd=6;
    }

    // SHOTGUN
    if(mouse.r && this.cd<=0){
      for(let i=0;i<7;i++){
        bullets.push(new Bullet(
          cx,cy,
          ang+(Math.random()-.5)*0.35,
          0.6,false
        ));
      }
      this.cd=20;
    }
  }
  draw(){
    ctx.fillStyle="#ccc";
    rr(ctx,this.x,this.y,this.w,this.h,6);
    ctx.fill();
  }
}
const player=new Player();

// ==========================================================
// ENEMY
// ==========================================================
class Enemy{
  constructor(x,y){
    this.x=x;this.y=y;
    this.w=32;this.h=64;
    this.vy=0;
    this.dead=false;

    this.parts={head:true,l:true,r:true};

    this.body=document.createElement("canvas");
    this.body.width=70;this.body.height=120;
    this.b=this.body.getContext("2d");
    this.redraw();
  }

  redraw(){
    const c=this.b;
    c.clearRect(0,0,70,120);

    // legs
    c.fillStyle="#222";
    c.fillRect(28,70,8,35);
    c.fillRect(36,70,8,35);

    // torso
    c.fillStyle="#444";
    rr(c,22,30,26,40,6);
    c.fill();

    // arms
    c.fillStyle="#333";
    if(this.parts.l) c.fillRect(10,34,10,28);
    if(this.parts.r) c.fillRect(50,34,10,28);

    // head
    if(this.parts.head){
      c.beginPath();
      c.arc(35,16,10,0,Math.PI*2);
      c.fillStyle="#555";
      c.fill();
    }
  }

  hit(x,y,power){
    const ly=y-this.y;
    if(ly<18 && this.parts.head){this.parts.head=false;this.dead=true;}
    else if(ly<45){this.parts[Math.random()<0.5?"l":"r"]=false;}
    else this.dead=true;

    this.b.globalCompositeOperation="destination-out";
    this.b.beginPath();
    this.b.arc(x-this.x+35,y-this.y,10+power*6,0,Math.PI*2);
    this.b.fill();
    this.b.globalCompositeOperation="source-over";

    for(let i=0;i<10;i++) particles.push(new Particle(x,y));
    decal(x,y);
    this.redraw();
  }

  update(){
    this.vy+=0.7;
    this.y+=this.vy;

    platforms.forEach(p=>{
      if(this.x+this.w>p.x && this.x<p.x+p.w){
        if(this.y+this.h<=p.y+10 && this.y+this.h>=p.y){
          this.y=p.y-this.h;
          this.vy=0;
        }
      }
    });

    if(!this.dead){
      const dx=player.x-this.x;
      const dy=player.y-this.y;
      if(Math.hypot(dx,dy)<420 && Math.random()<0.012){
        bullets.push(new Bullet(
          this.x+16,this.y+30,
          Math.atan2(dy,dx),1,true
        ));
      }
    }
  }

  draw(){
    ctx.drawImage(this.body,this.x-19,this.y-20);
  }
}

const enemies=[
  new Enemy(420,380),
  new Enemy(680,310),
  new Enemy(980,250)
];

// ==========================================================
// LOOP
// ==========================================================
function loop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // background
  ctx.fillStyle="#1f1f1f";
  platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

  decals.forEach(d=>{
    ctx.fillStyle=`rgba(80,0,0,${d.l/350})`;
    ctx.beginPath();
    ctx.arc(d.x,d.y,d.r,0,Math.PI*2);
    ctx.fill();
    d.l--;
  });

  player.update();
  enemies.forEach(e=>e.update());

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.update();
    if(b.life<=0) bullets.splice(i,1);

    if(!b.enemy){
      enemies.forEach(e=>{
        if(b.x>e.x&&b.x<e.x+e.w&&b.y>e.y&&b.y<e.y+e.h){
          e.hit(b.x,b.y,b.power);
          b.life=0;
        }
      });
    }
  }

  particles.forEach(p=>p.update());
  for(let i=particles.length-1;i>=0;i--) if(particles[i].l<=0) particles.splice(i,1);

  bullets.forEach(b=>b.draw());
  enemies.forEach(e=>e.draw());
  particles.forEach(p=>p.draw());
  player.draw();

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
