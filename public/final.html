<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pedro-Style NYC Alley â€” Ragdoll Edition</title>
<style>
html,body{margin:0;background:#0a0a0a;overflow:hidden}
canvas{display:block;margin:auto;background:#111}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
// ==========================================================
// CORE
// ==========================================================
const c=document.getElementById("c"),ctx=c.getContext("2d");
c.width=1280;c.height=640;

// ==========================================================
// INPUT
// ==========================================================
const keys={},mouse={x:0,y:0,l:false};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
c.onmousemove=e=>{
  const r=c.getBoundingClientRect();
  mouse.x=e.clientX-r.left;
  mouse.y=e.clientY-r.top;
};
c.onmousedown=()=>mouse.l=true;
c.onmouseup=()=>mouse.l=false;

// ==========================================================
// MAP (NYC ALLEY)
// ==========================================================
const platforms=[
  {x:-400,y:600,w:2400,h:80},
  {x:80,y:500,w:260,h:20},
  {x:420,y:460,w:260,h:20},
  {x:760,y:420,w:260,h:20},
  {x:1050,y:380,w:200,h:20},
  {x:250,y:330,w:180,h:20},
  {x:620,y:280,w:180,h:20},
];

// ==========================================================
// UTILS
// ==========================================================
function collideFloor(obj,h){
  let grounded=false;
  platforms.forEach(p=>{
    if(obj.x>p.x&&obj.x<p.x+p.w){
      if(obj.y+h<=p.y+12&&obj.y+h+obj.vy>=p.y){
        obj.y=p.y-h;
        obj.vy=0;
        grounded=true;
      }
    }
  });
  return grounded;
}

// ==========================================================
// BULLETS
// ==========================================================
const bullets=[];
class Bullet{
  constructor(x,y,a,s){
    this.x=x;this.y=y;
    this.vx=Math.cos(a)*s;
    this.vy=Math.sin(a)*s;
    this.life=50;
  }
  update(){this.x+=this.vx;this.y+=this.vy;this.life--;}
  draw(){
    ctx.fillStyle="#0ff";
    ctx.fillRect(this.x-2,this.y-2,4,4);
  }
}

// ==========================================================
// HUMANOID DRAW
// ==========================================================
function drawHuman(x,y,aim){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#444";
  ctx.fillRect(-8,6,16,24);
  ctx.beginPath();
  ctx.arc(0,-4,7,0,Math.PI*2);
  ctx.fillStyle="#555";
  ctx.fill();
  ctx.rotate(aim);
  ctx.fillStyle="#333";
  ctx.fillRect(4,10,14,3);
  ctx.fillStyle="#111";
  ctx.fillRect(18,9,10,5);
  ctx.restore();
}

// ==========================================================
// PLAYER
// ==========================================================
const player={x:100,y:300,vx:0,vy:0,w:20,h:48,ground:false,cd:0};
function updatePlayer(){
  player.vx=((keys.a?-1:0)+(keys.d?1:0))*6;
  player.vy+=0.8;
  if(keys[" "]&&player.ground){player.vy=-14;player.ground=false;}
  player.x+=player.vx;player.y+=player.vy;
  player.ground=collideFloor(player,player.h);

  player.cd--;
  if(mouse.l&&player.cd<=0){
    const cx=player.x+player.w/2,cy=player.y+14;
    const a=Math.atan2(mouse.y-cy,mouse.x-cx);
    bullets.push(new Bullet(cx,cy,a,18));
    player.cd=7;
  }
}

// ==========================================================
// RAGDOLL
// ==========================================================
class Ragdoll{
  constructor(x,y,impulse){
    this.parts=[
      {x,y,vx:impulse.x,vy:impulse.y,r:0},        // torso
      {x,y-14,vx:impulse.x*.8,vy:impulse.y-.5,r:0}, // head
      {x-6,y+18,vx:impulse.x-.5,vy:impulse.y,r:0}, // leg
      {x+6,y+18,vx:impulse.x+.5,vy:impulse.y,r:0},
    ];
  }
  update(){
    this.parts.forEach(p=>{
      p.vy+=0.7;
      p.x+=p.vx;
      p.y+=p.vy;
      collideFloor(p,8);
      p.vx*=0.98;
    });
  }
  draw(){
    ctx.fillStyle="#333";
    this.parts.forEach(p=>{
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.r);
      ctx.fillRect(-4,-4,8,8);
      ctx.restore();
    });
  }
}

// ==========================================================
// ENEMY
// ==========================================================
class Enemy{
  constructor(x,y){
    this.x=x;this.y=y;
    this.vx=1.2;this.vy=0;
    this.dir=1;
    this.state="patrol";
    this.dead=false;
    this.ragdoll=null;
    this.patrol=[x-100,x+100];
  }
  update(){
    if(this.dead){
      this.ragdoll.update();
      return;
    }

    // AI
    if(Math.abs(player.x-this.x)<260) this.state="attack";
    else this.state="patrol";

    if(this.state==="patrol"){
      this.x+=this.vx*this.dir;
      if(this.x<this.patrol[0]||this.x>this.patrol[1])this.dir*=-1;
    }

    this.vy+=0.6;
    this.y+=this.vy;
    collideFloor(this,48);
  }
  hit(b){
    this.dead=true;
    this.ragdoll=new Ragdoll(
      this.x,this.y,
      {x:b.vx*.2,y:b.vy*.2}
    );
  }
  draw(){
    if(this.dead) this.ragdoll.draw();
    else drawHuman(this.x,this.y,
      Math.atan2(player.y-this.y,player.x-this.x));
  }
}

const enemies=[
  new Enemy(520,440),
  new Enemy(820,400),
  new Enemy(1100,360)
];

// ==========================================================
// LOOP
// ==========================================================
function loop(){
  ctx.clearRect(0,0,c.width,c.height);

  ctx.fillStyle="#1a1a1a";
  platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

  updatePlayer();
  enemies.forEach(e=>e.update());

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];b.update();
    enemies.forEach(e=>{
      if(!e.dead && b.x>e.x-8 && b.x<e.x+8 && b.y>e.y && b.y<e.y+48){
        e.hit(b);b.life=0;
      }
    });
    if(b.life<=0) bullets.splice(i,1);
  }

  bullets.forEach(b=>b.draw());
  enemies.forEach(e=>e.draw());
  drawHuman(player.x,player.y,
    Math.atan2(mouse.y-(player.y+14),mouse.x-(player.x+10)));

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
