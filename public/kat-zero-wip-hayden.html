<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Katana Zero Style Game</title>
  <style>
    body {
      margin: 0;
      background: #111;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #1a1a1a;
    }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="960" height="540"></canvas>
<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const TILE_SIZE = 48;
  const map = [
    "............................",
    "............................",
    "............................",
    "...............#####........",
    "............................",
    "......####..............####",
    "..................##........",
    "...............##...........",
    "############################"
  ];

  const keys = {};
  document.addEventListener("keydown", e => keys[e.key] = true);
  document.addEventListener("keyup", e => keys[e.key] = false);

  const GRAVITY = 0.5;
  const FRICTION = 0.8;
  let slowMo = false;

  class Player {
    constructor() {
      this.x = 100;
      this.y = 100;
      this.w = 30;
      this.h = 48;
      this.vx = 0;
      this.vy = 0;
      this.onGround = false;
      this.facing = 1;
      this.attacking = false;
      this.dead = false;
    }

    update() {
      if (this.dead) return;

      // Input
      if (keys["a"] || keys["ArrowLeft"]) this.vx = -4;
      else if (keys["d"] || keys["ArrowRight"]) this.vx = 4;
      else this.vx *= FRICTION;

      if ((keys["w"] || keys["ArrowUp"]) && this.onGround) {
        this.vy = -10;
        this.onGround = false;
      }

      if (keys["Shift"]) slowMo = true;
      else slowMo = false;

      if (keys[" "]) this.attack();

      this.vy += GRAVITY;

      this.x += this.vx;
      this.y += this.vy;

      this.handleCollisions();

      if (this.vx > 0) this.facing = 1;
      else if (this.vx < 0) this.facing = -1;
    }

    handleCollisions() {
      this.onGround = false;
      for (let y = 0; y < map.length; y++) {
        for (let x = 0; x < map[y].length; x++) {
          if (map[y][x] === "#") {
            const tileX = x * TILE_SIZE;
            const tileY = y * TILE_SIZE;

            if (
              this.x < tileX + TILE_SIZE &&
              this.x + this.w > tileX &&
              this.y < tileY + TILE_SIZE &&
              this.y + this.h > tileY
            ) {
              // Simple collision resolution
              if (this.vy > 0) {
                this.y = tileY - this.h;
                this.vy = 0;
                this.onGround = true;
              } else if (this.vy < 0) {
                this.y = tileY + TILE_SIZE;
                this.vy = 0;
              }
            }
          }
        }
      }
    }

    attack() {
      this.attacking = true;
      setTimeout(() => this.attacking = false, 100);
    }

    draw() {
      ctx.fillStyle = "#4ff";
      ctx.fillRect(this.x, this.y, this.w, this.h);
      if (this.attacking) {
        ctx.fillStyle = "#f00";
        ctx.fillRect(this.x + this.facing * 30, this.y + 10, 20, 5);
      }
    }

    reset() {
      this.x = 100;
      this.y = 100;
      this.vx = this.vy = 0;
      this.dead = false;
    }
  }

  class Particle {
    constructor(x, y, color) {
      this.x = x;
      this.y = y;
      this.vx = Math.random() * 4 - 2;
      this.vy = Math.random() * -4;
      this.life = 30;
      this.color = color;
    }

    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += 0.2;
      this.life--;
    }

    draw() {
      ctx.fillStyle = this.color;
      ctx.fillRect(this.x, this.y, 3, 3);
    }
  }

  class Enemy {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.w = 30;
      this.h = 48;
      this.vx = 1.5;
      this.alive = true;
    }

    update(player) {
      if (!this.alive) return;

      // Patrol AI
      this.x += this.vx;

      // Turn on wall edge
      const tileBelow = getTileAt(this.x + this.vx + this.w / 2, this.y + this.h + 2);
      const tileAhead = getTileAt(this.x + this.vx * 10, this.y + this.h / 2);
      if (tileBelow !== "#" || tileAhead === "#") {
        this.vx *= -1;
      }

      // Detect player attack
      if (player.attacking &&
        player.x + player.facing * 30 < this.x + this.w &&
        player.x + player.facing * 30 + 20 > this.x &&
        player.y + 10 < this.y + this.h &&
        player.y + 10 + 5 > this.y) {
        this.alive = false;
        for (let i = 0; i < 20; i++) {
          particles.push(new Particle(this.x + this.w / 2, this.y + this.h / 2, "#f00"));
        }
      }

      // Collide with player = death
      if (
        player.x < this.x + this.w &&
        player.x + player.w > this.x &&
        player.y < this.y + this.h &&
        player.y + player.h > this.y
      ) {
        player.dead = true;
      }
    }

    draw() {
      if (!this.alive) return;
      ctx.fillStyle = "#0f0";
      ctx.fillRect(this.x, this.y, this.w, this.h);
    }
  }

  function getTileAt(px, py) {
    const tx = Math.floor(px / TILE_SIZE);
    const ty = Math.floor(py / TILE_SIZE);
    if (ty >= 0 && ty < map.length && tx >= 0 && tx < map[0].length) {
      return map[ty][tx];
    }
    return ".";
  }

  const player = new Player();
  const enemies = [
    new Enemy(600, 300),
    new Enemy(750, 300),
  ];
  const particles = [];

  function loop() {
    if (keys["r"]) {
      player.reset();
      enemies.forEach(e => e.alive = true);
    }

    const delta = slowMo ? 0.5 : 1;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw map
    for (let y = 0; y < map.length; y++) {
      for (let x = 0; x < map[y].length; x++) {
        if (map[y][x] === "#") {
          ctx.fillStyle = "#555";
          ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
      }
    }

    for (let i = 0; i < delta; i++) {
      player.update();
      enemies.forEach(e => e.update(player));
      particles.forEach(p => p.update());
    }

    player.draw();
    enemies.forEach(e => e.draw());
    particles.forEach(p => p.draw());

    // Clean up dead particles
    for (let i = particles.length - 1; i >= 0; i--) {
      if (particles[i].life <= 0) particles.splice(i, 1);
    }

    if (player.dead) {
      ctx.fillStyle = "rgba(255,0,0,0.6)";
      ctx.font = "bold 32px sans-serif";
      ctx.fillText("YOU DIED - Press R to Restart", 300, 200);
    }

    requestAnimationFrame(loop);
  }

  loop();
</script>
</body>
</html>
